{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>LindaMama - My Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }
    .navbar-brand {
      font-weight: bold;
      color: #e83e8c !important;
    }
    .btn-primary {
      background-color: #e83e8c;
      border-color: #e83e8c;
    }
    .btn-primary:hover {
      background-color: #d81b7e;
      border-color: #d81b7e;
    }
    .profile-header {
      position: relative;
    }
    .profile-avatar {
      position: relative;
      display: inline-block;
    }
    .avatar-img, .avatar-placeholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .avatar-placeholder {
      background: linear-gradient(135deg, #e83e8c, #ff9ec0);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 600;
    }
    .avatar-overlay {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 35px;
      height: 35px;
      background: #e83e8c;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .profile-avatar:hover .avatar-overlay {
      opacity: 1;
    }
    .profile-name {
      color: #212529;
      margin-bottom: 0.5rem;
    }
    .info-item, .contact-item {
      display: flex;
      align-items: flex-start;
      padding: 1rem 0;
      border-bottom: 1px solid #e9ecef;
    }
    .info-item:last-child, .contact-item:last-child {
      border-bottom: none;
    }
    .info-item i, .contact-item i {
      font-size: 1.2rem;
      margin-top: 0.25rem;
      width: 24px;
    }
    .settings-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .settings-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 10px;
      text-decoration: none;
      color: #212529;
      transition: background-color 0.3s ease;
      border: 1px solid transparent;
    }
    .settings-item:hover {
      background-color: #f8f9fa;
      border-color: #e9ecef;
      color: #212529;
    }
    .settings-item i:first-child {
      font-size: 1.2rem;
      width: 24px;
      margin-right: 1rem;
    }
    .settings-item div {
      flex: 1;
    }
    .settings-item i:last-child {
      margin-left: auto;
    }
    .stat {
      padding: 1rem;
    }
    .stat h3 {
      font-weight: 700;
    }
    .emergency-contact {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 1rem;
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .card-header {
      background-color: white;
      border-bottom: 1px solid #e9ecef;
      padding: 1rem 1.5rem;
    }
    .card-title {
      margin-bottom: 0;
      color: #212529;
    }
    .form-control:focus {
      border-color: #e83e8c;
      box-shadow: 0 0 0 0.2rem rgba(232, 62, 140, 0.25);
    }
    .footer {
      background-color: #f8f9fa;
      padding: 2rem 0;
      margin-top: 3rem;
    }
    .user-welcome {
      color: #e83e8c;
      font-weight: 600;
    }
    .progress-bar {
      background-color: #e83e8c;
    }
    @media (max-width: 768px) {
      .avatar-img, .avatar-placeholder {
        width: 100px;
        height: 100px;
        font-size: 2rem;
      }
      .profile-name {
        font-size: 1.5rem;
      }
      .info-item, .contact-item {
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
      }
      .info-item i, .contact-item i {
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="{% url 'home' %}">LindaMama</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="{% url 'profile' %}">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'resources' %}">Resources</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <span class="navbar-text user-welcome me-3">
            Welcome, {{ user.first_name|default:user.username }}!
          </span>
        </li>
        <li class="nav-item">
          <form method="post" action="{% url 'logout' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm">Logout</button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container py-4">
  <!-- Messages block -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Display form errors -->
  {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show">
      <strong>Please correct the errors below:</strong>
      <ul class="mb-0">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ field|title }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Profile Header -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <div class="profile-header">
                        <div class="profile-avatar mb-3">
                            <!-- Dynamic profile picture placeholder with user initials -->
                            <div class="avatar-placeholder">
                                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                            </div>
                            <div class="avatar-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <h2 class="profile-name">{{ user.first_name }} {{ user.last_name }}</h2>
                        <p class="text-muted mb-2">
                            <i class="fas fa-user-tag me-2"></i>
                            Expecting Mother
                        </p>
                        <p class="text-muted">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Member since {{ user.date_joined|date:"F Y" }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Personal Information -->
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-user me-2"></i>Personal Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_first_name" class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="id_first_name" name="first_name" 
                                               value="{{ form.first_name.value|default:user.first_name }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_last_name" class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="id_last_name" name="last_name" 
                                               value="{{ form.last_name.value|default:user.last_name }}" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="id_username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="id_username" name="username" 
                                           value="{{ user.username }}" readonly>
                                    <div class="form-text">Username cannot be changed</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="id_email" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="id_email" name="email" 
                                           value="{{ form.email.value|default:user.email }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="id_phone_number" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="id_phone_number" name="phone_number" 
                                           value="{{ form.phone_number.value|default:profile.phone_number|default:'' }}"
                                           placeholder="+255 XXX XXX XXX">
                                </div>

                                <div class="d-grid">
                                    <button type="submit" name="update_profile" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Update Profile
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-phone-alt me-2"></i>Emergency Contact
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="emergency-contact">
                                <div class="contact-item">
                                    <i class="fas fa-user text-primary me-3"></i>
                                    <div>
                                        <strong>{{ profile.emergency_contact|default:"Not set" }}</strong>
                                        <p class="text-muted mb-0">
                                            {% if profile.emergency_contact %}
                                                Emergency Contact
                                            {% else %}
                                                No emergency contact set
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary w-100 mt-3" data-bs-toggle="modal" data-bs-target="#emergencyContactModal">
                                <i class="fas fa-edit me-2"></i>
                                {% if profile.emergency_contact %}Edit{% else %}Add{% endif %} Emergency Contact
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pregnancy Information -->
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-baby me-2"></i>Pregnancy Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="pregnancy-info">
                                {% if profile %}
                                <!-- Pregnancy Progress -->
                                {% with progress=profile.get_pregnancy_progress week_data=profile.calculate_pregnancy_week trimester=profile.get_trimester %}
                                <div class="info-item">
                                    <i class="fas fa-chart-line text-info me-3"></i>
                                    <div>
                                        <strong>Pregnancy Progress</strong>
                                        {% if week_data %}
                                        <div class="progress mt-2" style="height: 20px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ progress }}%;" 
                                                 aria-valuenow="{{ progress }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{ progress|floatformat:0 }}%
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ progress|floatformat:0 }}% complete</small>
                                        {% else %}
                                        <p class="mb-0 text-muted">Set your LMP to see progress</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="info-item">
                                    <i class="fas fa-baby-carriage text-success me-3"></i>
                                    <div>
                                        <strong>Current Week</strong>
                                        <p class="mb-0">
                                            {% if week_data %}
                                                Week {{ week_data.week }} (Day {{ week_data.day }})
                                            {% else %}
                                                Not set
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>

                                <div class="info-item">
                                    <i class="fas fa-calendar text-primary me-3"></i>
                                    <div>
                                        <strong>Due Date</strong>
                                        <p class="mb-0">{{ profile.due_date|date:"F d, Y"|default:"Not set" }}</p>
                                    </div>
                                </div>

                                <div class="info-item">
                                    <i class="fas fa-calendar-check text-warning me-3"></i>
                                    <div>
                                        <strong>Last Menstrual Period</strong>
                                        <p class="mb-0">{{ profile.last_menstrual_period|date:"F d, Y"|default:"Not set" }}</p>
                                    </div>
                                </div>

                                <div class="info-item">
                                    <i class="fas fa-layer-group text-info me-3"></i>
                                    <div>
                                        <strong>Current Trimester</strong>
                                        <p class="mb-0">
                                            {% if trimester %}
                                                {{ trimester.name }}
                                            {% else %}
                                                Not set
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>

                                <div class="info-item">
                                    <i class="fas fa-heartbeat text-danger me-3"></i>
                                    <div>
                                        <strong>Blood Type</strong>
                                        <p class="mb-0">{{ profile.blood_type|default:"Not set" }}</p>
                                    </div>
                                </div>
                                {% endwith %}
                                {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-baby fa-3x mb-3"></i>
                                    <p>No pregnancy information set yet</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <button class="btn btn-outline-primary w-100 mt-3" data-bs-toggle="modal" data-bs-target="#pregnancyProfileModal">
                                <i class="fas fa-edit me-2"></i>Edit Pregnancy Information
                            </button>
                        </div>
                    </div>

                    <!-- Account Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-cog me-2"></i>Account Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="settings-list">
                                 
                                <a href="#" class="settings-item">
                                    <i class="fas fa-bell text-info"></i>
                                    <div>
                                        <strong>Notification Settings</strong>
                                        <p class="text-muted mb-0">Manage your notification preferences</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-muted"></i>
                                </a>
                                
                                <a href="#" class="settings-item">
                                    <i class="fas fa-shield-alt text-success"></i>
                                    <div>
                                        <strong>Privacy Settings</strong>
                                        <p class="text-muted mb-0">Control your privacy and data</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-muted"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Profile Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        {% with week_data=profile.calculate_pregnancy_week %}
                        <div class="col-md-3 mb-3">
                            <div class="stat">
                                <h3 class="text-primary mb-1">{{ week_data.week|default:"0" }}</h3>
                                <p class="text-muted mb-0">Weeks Pregnant</p>
                            </div>
                        </div>
                        {% endwith %}
                        <div class="col-md-3 mb-3">
                            <div class="stat">
                                <h3 class="text-success mb-1">{{ user.appointments.count|default:"0" }}</h3>
                                <p class="text-muted mb-0">Total Appointments</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat">
                                <h3 class="text-info mb-1">{{ user.health_metrics.count|default:"0" }}</h3>
                                <p class="text-muted mb-0">Vitals Records</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat">
                                <h3 class="text-warning mb-1">
                                    {% if profile.due_date %}
                                        {{ profile.due_date|timeuntil }}
                                    {% else %}
                                        Not set
                                    {% endif %}
                                </h3>
                                <p class="text-muted mb-0">Time to Due Date</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Emergency Contact Modal -->
<div class="modal fade" id="emergencyContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Emergency Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_emergency_contact" class="form-label">Emergency Contact</label>
                        <input type="text" class="form-control" id="id_emergency_contact" name="emergency_contact"
                               value="{{ profile.emergency_contact|default:'' }}"
                               placeholder="Enter full name and phone number">
                    </div>
                    <div class="mb-3">
                        <label for="id_phone_number_modal" class="form-label">Your Phone Number</label>
                        <input type="tel" class="form-control" id="id_phone_number_modal" name="phone_number"
                               value="{{ profile.phone_number|default:'' }}"
                               placeholder="Enter your phone number">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="update_emergency" class="btn btn-primary">Save Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Pregnancy Profile Modal -->
<div class="modal fade" id="pregnancyProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Pregnancy Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_last_menstrual_period" class="form-label">Last Menstrual Period (LMP) *</label>
                                <input type="date" class="form-control" id="id_last_menstrual_period" name="last_menstrual_period"
                                       value="{{ profile.last_menstrual_period|date:'Y-m-d'|default:'' }}" required>
                                <div class="form-text">
                                    First day of your last period - used to calculate pregnancy progress
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_due_date" class="form-label">Expected Due Date</label>
                                <input type="date" class="form-control" id="id_due_date" name="due_date"
                                       value="{{ profile.due_date|date:'Y-m-d'|default:'' }}">
                                <div class="form-text">
                                    Will be calculated automatically from LMP
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_blood_type" class="form-label">Blood Type</label>
                                <select class="form-select" id="id_blood_type" name="blood_type">
                                    <option value="">Select blood type</option>
                                    <option value="A+" {% if profile.blood_type == "A+" %}selected{% endif %}>A+</option>
                                    <option value="A-" {% if profile.blood_type == "A-" %}selected{% endif %}>A-</option>
                                    <option value="B+" {% if profile.blood_type == "B+" %}selected{% endif %}>B+</option>
                                    <option value="B-" {% if profile.blood_type == "B-" %}selected{% endif %}>B-</option>
                                    <option value="AB+" {% if profile.blood_type == "AB+" %}selected{% endif %}>AB+</option>
                                    <option value="AB-" {% if profile.blood_type == "AB-" %}selected{% endif %}>AB-</option>
                                    <option value="O+" {% if profile.blood_type == "O+" %}selected{% endif %}>O+</option>
                                    <option value="O-" {% if profile.blood_type == "O-" %}selected{% endif %}>O-</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_pregnancy_type" class="form-label">Pregnancy Type</label>
                                <select class="form-select" id="id_pregnancy_type" name="pregnancy_type">
                                    <option value="singleton" {% if profile.pregnancy_type == "singleton" %}selected{% endif %}>Singleton</option>
                                    <option value="twins" {% if profile.pregnancy_type == "twins" %}selected{% endif %}>Twins</option>
                                    <option value="triplets" {% if profile.pregnancy_type == "triplets" %}selected{% endif %}>Triplets</option>
                                    <option value="multiple" {% if profile.pregnancy_type == "multiple" %}selected{% endif %}>Multiple</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_allergies" class="form-label">Known Allergies</label>
                        <textarea class="form-control" id="id_allergies" name="allergies" 
                                  rows="3" placeholder="List any known allergies...">{{ profile.allergies|default:'' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_address" class="form-label">Address</label>
                        <textarea class="form-control" id="id_address" name="address" 
                                  rows="3" placeholder="Enter your current address...">{{ profile.address|default:'' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="update_pregnancy" class="btn btn-primary">Update Information</button>
                </div>
            </form>
        </div>
    </div>
</div>

<footer class="footer">
  <div class="container text-center">
    <p>&copy; 2023 LindaMama. All rights reserved.</p>
    <p class="text-muted">Your trusted pregnancy companion</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate due date when LMP is entered
    const lmpInput = document.getElementById('id_last_menstrual_period');
    const dueDateInput = document.getElementById('id_due_date');
    
    if (lmpInput && dueDateInput) {
        lmpInput.addEventListener('change', function() {
            if (this.value && !dueDateInput.value) {
                const lmpDate = new Date(this.value);
                const dueDate = new Date(lmpDate);
                dueDate.setDate(dueDate.getDate() + 280); // 40 weeks = 280 days
                
                // Format date as YYYY-MM-DD
                const formattedDueDate = dueDate.toISOString().split('T')[0];
                dueDateInput.value = formattedDueDate;
            }
        });
    }
    
    // Form validation
    const profileForm = document.querySelector('form[method="post"]');
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            const firstName = document.getElementById('id_first_name').value;
            const lastName = document.getElementById('id_last_name').value;
            const email = document.getElementById('id_email').value;
            
            if (!firstName || !lastName || !email) {
                e.preventDefault();
                alert('Please fill in all required fields (First Name, Last Name, and Email).');
                return false;
            }
        });
    }
});
</script>
</body>
</html>

